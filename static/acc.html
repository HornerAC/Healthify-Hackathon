<!doctype html>
<html class="no-js" lang="">

	<head>
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />
		<meta content="IE=edge" http-equiv="X-UA-Compatible">
		<meta content="#1a1a1a" name="theme-color">
		<meta http-equiv="content-type" content="text/html; charset=UTF-16">
		<title>Acc</title>
	</head>

	<body>

		<div id="output"></div>
		<input type="number" id="freq" name="freq" value="10" placeholder="Frequency" max="60" />
		<textarea id="readings" style="width:100%; height:75vh;"></textarea>
		<button id="update">Update</button>
		<button id="stop">Stop!</button>
		<button id="send">Upload</button>


      	<script type="text/javascript">
			const out = document.getElementById("output");
			const read = document.getElementById("readings");
			const upd = document.getElementById("update");
			const stop = document.getElementById("stop");
			const send = document.getElementById("send");
			const freq = document.getElementById("freq");

			var acc = null;
			var running = false;
			var dataset = [];


			function checkPermission(){
				navigator.permissions.query({ name: 'accelerometer' }).then(result => {
					out.innerHTML = result.state;

					upd.disabled = result.state !== "granted";
					upd.innerHTML = result.state !== "granted" ? "No permission!" : "Start readings..";
				});
			}
			
			function uploadData(){
				let data = dataset;
				console.log(JSON.stringify(dataset));

				dataset = [];
			}

			function round(num, dp){
				let p = Math.pow(10,dp);
				return Math.round(num * p) / p;
			}

			function begin(){
				if (running){
					running = false;
					acc.stop();
					return;
				}
				read.value = "";

				acc = new Accelerometer({frequency: parseInt(freq.value)});
				acc.addEventListener('reading', e => {
					var readData = {
						x:round(acc.x,1),
						y:round(acc.y,1),
						z:round(acc.z,1)
					};
					var reading = JSON.stringify(readData) + "\n";

					dataset.push(readData);
					read.value = read.value + reading;
				});

				acc.start();
			}

			function stopRead(){
				acc.stop();
			}

			upd.addEventListener("click",begin);
			stop.addEventListener("click",stopRead);
			send.addEventListener("click",uploadData);
			checkPermission();
      	</script>

	</body>

</html>
